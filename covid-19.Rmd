---
title: "COVID-19 UK monitor"
output: 
  flexdashboard::flex_dashboard:
    theme: lumen
    orientation: rows
    logo: logo.png
    source_code: https://github.com/traffordDataLab/covid-19
    social: ["twitter"]
    css: styles.css
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard) ; library(shiny) ; library(tidyverse) ; library(httr) ; library(readxl) ;  library(sf) ;  library(htmlwidgets) ; library(htmltools) ; library(leaflet) ; library(leaflet.extras) ; library(scales) ; library(classInt) ; library(plotly) 

# Data published by Public Health England 
# https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases

# Total confirmed cases for countries of the UK and total deaths in the UK
# URL: https://www.arcgis.com/home/item.html?id=bc8ee90225644ef7a6f4dd1b13ea1d67
url <- "https://www.arcgis.com/sharing/rest/content/items/bc8ee90225644ef7a6f4dd1b13ea1d67/data"
GET(url, write_disk(tmp <- tempfile(fileext = ".xlsx")))
daily_indicators <- read_xlsx(tmp) %>% 
  mutate(DateVal = as.Date(DateVal, format = "%d/%m/%y"))

# Confirmed cases by country
cases_by_country <- tibble(
  area_code = c("N92000002", "S92000003", "W92000004"),
  TotalCases = c(daily_indicators$NICases, daily_indicators$ScotlandCases, daily_indicators$WalesCases)
)

# Time series of daily confirmed cases in the UK
# URL: https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11
url <- "https://www.arcgis.com/sharing/rest/content/items/e5fd11150d274bebaaf8fe2a7a2bda11/data"
GET(url, write_disk(tmp <- tempfile(fileext = ".xlsx")))
daily_cases <- read_xlsx(tmp) %>% 
  mutate(DateVal = as.Date(DateVal, format = "%d/%m/%y"))

# Total confirmed cases by Upper Tier Local Authority in England
# URL: https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6
utla_cases <- read_csv("https://www.arcgis.com/sharing/rest/content/items/b684319181f94875a6879bbc833ca3a6/data") %>% 
  select(area_code = GSS_CD, TotalCases) %>% 
  bind_rows(cases_by_country)

cases_by_area <- st_read("data/areas.geojson") %>% 
  left_join(utla_cases, by = "area_code") %>%
  mutate(rate = round((TotalCases/population)*100000, 1),
         cases_popup = str_c("<strong>", area_name, "</strong><br/>", TotalCases, " cases") %>% map(HTML),
         rate_popup = str_c("<strong>", area_name, "</strong><br/>", rate, " cases per 100,000 population") %>% map(HTML)) %>% 
  select(-geometry, everything())

# Time series of daily confirmed deaths in the UK
# URL: https://fingertips.phe.org.uk/documents/Historic%20COVID-19%20Dashboard%20Data.xlsx
daily_deaths <- read_csv("https://github.com/traffordDataLab/covid-19/raw/master/data/daily_deaths.csv", col_types = cols(
  Date = col_date(format = "%Y-%m-%d"),
  NewDeaths = col_integer(),
  CumDeaths = col_integer()))
```

Cases 
=======================================================================

Row
-------------------------------------

### <strong>New confirmed UK cases</strong><br/><small>as of `r format(daily_indicators$DateVal, '%d %B %Y')`</small>
```{r}
valueBox(comma(pull(filter(daily_cases, DateVal == max(DateVal)), CMODateCount)))
```

### <strong>Total confirmed UK cases</strong><br/><small>as of `r format(daily_indicators$DateVal, '%d %B %Y')`</small>
```{r}
valueBox(comma(max(daily_cases$CumCases)))
```

Row
-------------------------------------

### Daily confirmed cases
```{r}
renderPlotly({
  p <- ggplot(daily_cases, aes(x = DateVal, y = CMODateCount, text = paste0("<b>", comma(CMODateCount), "</b> cases<br>", format(DateVal, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_col(fill = "#57AACB") +
    scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), labels = comma) +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = "Source: Public Health England") +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) 
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE))  
})
```

### Cumulative confirmed cases
```{r}
fillCol(flex = c(NA, 1),
        radioButtons("cases_scale", label = NULL, choices = c("Linear", "Logarithmic"), selected = "Linear", inline = TRUE),
        plotlyOutput("cases_plot", height = "100%")
        )

output$cases_plot <- renderPlotly({
  p <- ggplot(daily_cases, aes(x = DateVal, y = CumCases, group = 1, text = paste0("<b>", comma(CumCases), "</b> cases<br>", format(DateVal, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_line(colour = "#57AACB", size = 1) +
    scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = "Source: Public Health England") +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15)))
  
    if (input$cases_scale == "Linear") {
    p <- p + geom_hline(yintercept = 0, size = 0.3, colour = "#333333") + scale_y_continuous(expand = c(0.005, 0.005), labels = comma)
    } else {
      p <- p + geom_hline(yintercept = 1, size = 0.3, colour = "#333333") + scale_y_continuous(trans = "log10", expand = c(0.005, 0.005), labels = comma_format(accuracy = 1))
    }
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) 
})
```

Deaths 
=======================================================================

Row
-------------------------------------

### <strong>New confirmed UK deaths</strong><br/><small>as of `r format(max(daily_deaths$Date), '%d %B %Y')`</small>
```{r}
valueBox(comma(pull(filter(daily_deaths, Date == max(Date)), NewDeaths)))
```

### <strong>Total confirmed UK deaths</strong><br/><small>as of `r format(max(daily_deaths$Date), '%d %B %Y')`</small>
```{r}
valueBox(comma(max(daily_deaths$CumDeaths)))
```

Row
-------------------------------------

### Daily confirmed deaths
```{r}
renderPlotly({
  p <- ggplot(daily_deaths, aes(x = Date, y = NewDeaths, text = paste0("<b>", comma(NewDeaths), "</b> deaths<br>", format(Date, "%d %B")))) +
    geom_hline(yintercept = 0, size = 0.3, colour = "#333333") +
    geom_col(fill = "#57AACB") +
    scale_x_date(expand = c(0.005, 0.005), date_labels = "%d-%b") +
    scale_y_continuous(expand = c(0.005, 0.005), labels = comma) +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = "Source: Public Health England") +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15))) 
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) 
})
```

### Cumulative confirmed deaths
```{r}
fillCol(flex = c(NA, 1),
        radioButtons("deaths_scale", label = NULL, choices = c("Linear", "Logarithmic"), selected = "Linear", inline = TRUE),
        plotlyOutput("deaths_plot", height = "100%")
        )

output$deaths_plot <- renderPlotly({
  p <- ggplot(daily_deaths, aes(x = Date, y = CumDeaths, group = 1, text = paste0("<b>", comma(CumDeaths), "</b> deaths<br>", format(Date, "%d %B")))) +
    geom_line(colour = "#57AACB", size = 1) +
    scale_x_date(expand = c(0.005, 0.4), date_labels = "%d-%b") +
    labs(x = NULL, y = NULL, title = NULL, subtitle = NULL, caption = "Source: Public Health England") +
    theme_minimal() +
    theme(plot.margin = unit(rep(0.5, 4), "cm"),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank(),
          plot.caption = element_text(size = 10, color = "grey50", hjust = 1, margin = margin(t = 15)))
  
  if (input$deaths_scale == "Linear") {
    p <- p + geom_hline(yintercept = 0, size = 0.3, colour = "#333333") + scale_y_continuous(expand = c(0.005, 0.005), labels = comma)
    } else {
      p <- p + geom_hline(yintercept = 1, size = 0.3, colour = "#333333") + scale_y_continuous(trans = "log10", expand = c(0.005, 0.005), labels = comma_format(accuracy = 1))
    }
  
  ggplotly(p, tooltip = "text") %>%
    config(displayModeBar = FALSE) %>% 
    layout(xaxis = list(fixedrange = TRUE)) %>%
    layout(yaxis = list(fixedrange = TRUE)) 
})
```

Map
=======================================================================

### Confirmed cases by area
```{r}
renderLeaflet({
  leaflet() %>%
    setView(-3, 54.3, zoom = 6) %>% 
    addTiles(urlTemplate = "",
           attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Source: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', options = providerTileOptions(minZoom = 5, maxZoom = 9)) %>%
    addPolygons(data = cases_by_area, fillColor = "#EAEAEA", fillOpacity = 0.3, weight = 1, color = "#bdbdbd") %>% 
    addCircleMarkers(data = cases_by_area, lng = ~long, lat = ~lat, radius = ~sqrt(TotalCases), fillColor = "#57AACB", fillOpacity = 0.8, weight = 1, color = "#FFFFFF", opacity = 1, label = ~cases_popup) %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
    "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
    paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

### Infection rate by area
```{r}
renderLeaflet({
  breaks <- classIntervals(cases_by_area$rate, n = 5, style = "jenks")$brks
  pal <- colorBin(palette = "Blues", domain = NULL, bins = breaks, na.color = "#FFFFFF")
  
  leaflet(data = cases_by_area) %>%
    setView(-3, 54.3, zoom = 6) %>% 
    addTiles(urlTemplate = "", attribution = '<a href="https://www.ons.gov.uk/methodology/geography/licences">Contains OS data © Crown copyright and database right (2020)</a> | Source: <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>', options = providerTileOptions(minZoom = 5, maxZoom = 9)) %>%
    addPolygons(fillColor = ~pal(rate), fillOpacity = 0.8, smoothFactor = 0.5, stroke = TRUE, weight = 1, color = "#bdbdbd", opacity = 1, label = ~rate_popup, labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "15px", direction = "auto"), highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~rate, opacity = 0.7, title = "Cases per 100,000 population", position = "bottomright") %>% 
    addFullscreenControl() %>% 
    addResetMapButton() %>% 
    onRender(
      "function(el, t) {var myMap = this;myMap._container.style['background'] = '#ffffff';}",
      paste0("function(el, x) {$('head').append(","\'<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\'",");}"))
})
```

About {data-icon="fa-info-circle"}
=======================================================================

### 

<div class = "about">
<p>This dashboard visualises daily confirmed coronavirus cases and deaths in the UK published by <a href="https://www.gov.uk/government/publications/covid-19-track-coronavirus-cases" target="_blank">Public Health England</a>. Further information about Coronavirus (COVID-19) can be found at: <a href="https://www.gov.uk/coronavirus" target="_blank">gov.uk/coronavirus</a></p>
<strong>Please note</strong>
  <ul>
    <li>The number of <em>confirmed</em> cases is likely to be much lower than the <em>total</em> number of cases because some people who report symptoms are not being tested</li>
    <li>The number of confirmed deaths only includes those who have died in hospital</li>
    <li>The date refers to the date of <em>reporting</em> not necessarily the date that of confirmed cases or deaths</li>
  </ul>
<strong>Data sources</strong>
<p>As of 25 March 2020, the reporting period for UK COVID-19 deaths  <a href="https://twitter.com/DHSCgovuk/status/1243237211119800323" target="_blank">changed</a>. Confirmed cases would still cover the period between 9am - 9am on the date of publication but deaths would refer to the 24 hour period before 5pm on the previous day. This means that with <a href="https://www.gov.uk/guidance/coronavirus-covid-19-information-for-the-public#number-of-cases" target="_blank">a 2pm publication</a> there is a 5 hour lag between the recording and publication of confirmed cases but a 21 hour lag for deaths.</p>
 <ul>
    <li><a href="https://www.arcgis.com/home/item.html?id=bc8ee90225644ef7a6f4dd1b13ea1d67" target="_blank">Total confirmed cases for countries of the UK and total deaths in the UK</a></li>
    <li><a href="https://www.arcgis.com/home/item.html?id=e5fd11150d274bebaaf8fe2a7a2bda11" target="_blank">Time series of daily confirmed cases in the UK</a></li>
    <li><a href="https://www.arcgis.com/home/item.html?id=b684319181f94875a6879bbc833ca3a6" target="_blank">Total confirmed cases by Upper Tier Local Authority in England</a></li>
 </ul>
<strong>Credits</strong>
<p>This application was built in <a href="https://cran.r-project.org" target="_blank">R</a> using the <a href="https://cran.r-project.org/web/packages/shiny/index.html" target="_blank">shiny</a>, <a href="https://cran.r-project.org/web/packages/flexdashboard/index.html" target="_blank">flexdashboard</a>, <a href="https://cran.r-project.org/web/packages/ggplot2/index.html" target="_blank">ggplot2</a>, <a href="https://cran.r-project.org/web/packages/plotly/index.html" target="_blank">plotly</a> and <a href="https://cran.r-project.org/web/packages/leaflet/index.html" target="_blank">leaflet</a> packages.</p>
</div>